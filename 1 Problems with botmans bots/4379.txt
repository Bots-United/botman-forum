--------------------------------------------------
Subject: HPB_bot and hlds_l 3111
--------------------------------------------------
05/04/03 at 12:14:10  Posted by: BAStumm (bs@bs-linux.com)
--------------------------------------------------
Anyone having problems with HPB_bot and hlds 3111 (linux). I can run the server fine if I load the tfc dll but if I try to load the HPB_bot dll then it crashes with:

./hlds_run: line 83:  1744 Segmentation fault      (core dumped) $HL $*

warning: Unable to set global thread event mask: generic error
Error while reading shared library symbols:
Cannot enable thread event reporting for Thread 1024 (LWP 1744): generic error
Error accessing memory address 0xbfffdb30: No such process.
36      eval.c: No such file or directory.
Error accessing memory address 0xbfffdb30: No such process.
debug.cmds:1: Error in sourced command file:
Error accessing memory address 0xbfffdb14: No such process.
email debug.log to linux@valvesoftware.com
Sun May  4 12:21:10 PDT 2003: Server Died


and debug.log has:

----------------------------------------------
CRASH: Sun May  4 12:21:08 PDT 2003
Core was generated by `./hlds -game tfc -debug'.
Program terminated with signal 11, Segmentation fault.
[New Thread 1024 (LWP 1744)]
#0  __strtol_internal (nptr=) at eval.c:36
        in eval.c
#0  __strtol_internal (nptr=) at eval.c:36
End of crash report
----------------------------------------------


--------------------------------------------------
05/04/03 at 12:24:48  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
I'll download and install the x111 dedicated server update for Win32 and Linux and check into the problem.

I'll reply here with whatever I find out.

botman

--------------------------------------------------
05/04/03 at 12:27:24  Reply by: BAStumm (bs@bs-linux.com)
--------------------------------------------------
before the question is asked... Yes I did put the original hpb bot dll back in my tfc/dlls folder before posting here. By that I mean its not just my custom hpb bot dll that is crashing it. 

Also sent the debug info to alfred at valve.

I used the upgrade bin file, not hte full 3111 bin to upgrade.

--------------------------------------------------
05/04/03 at 14:30:41  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
Here's the fix.  In h_export.cpp change this (in the GiveFnptrsToDll function)...
code:
   // find the directory name of the currently running MOD...
   (*g_engfuncs.pfnGetGameDir)(game_dir);

   pos = strlen(game_dir) - 1;

   // scan backwards till first directory separator...
   while ((pos) && (game_dir[pos] != '/'))
      pos--;

   if (pos == 0)
   {
      // Error getting directory name!

            ALERT( at_error, "HPB_bot - Error determining MOD directory name!" );
   }

   pos++;
   strcpy(mod_name, &game_dir[pos]);

...to this...
code:
   // find the directory name of the currently running MOD...
   (*g_engfuncs.pfnGetGameDir)(game_dir);

   pos = 0;

   if (strstr(game_dir, "/") != NULL)
   {
      pos = strlen(game_dir) - 1;

      // scan backwards till first directory separator...
      while ((pos) && (game_dir[pos] != '/'))
         pos--;

      if (pos == 0)
      {
         // Error getting directory name!

               ALERT( at_error, "HPB_bot - Error determining MOD directory name!" );
      }

      pos++;
   }

   strcpy(mod_name, &game_dir[pos]);

Valve changed the way the pfnGetGameDir() function worked (by returning a partial path instead of the fully qualified pathname).

It will take me a little while to rebuild the Win32 and Linux binary version and make those plus the source code download available, but if you are modifying the source code yourself, or want to build it yourself, that change shown above should fix the problem.

I should have the binary downloads available in the next hour or so, if you don't want to build things yourself.

botman

--------------------------------------------------
05/04/03 at 15:36:03  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
Okay, Version 3.0 of the HPB bot is available for download...

http://planethalflife.com/botman/hpb_bot.shtml

botman

[modified on 05/04/03 at 15:36:03]
--------------------------------------------------
05/04/03 at 22:58:23  Reply by: BAStumm (bs@bs-linux.com)
--------------------------------------------------
seems to have done the trick. Modified the source and compiled it with you suggested changes.

--------------------------------------------------
05/05/03 at 05:32:55  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
Wheeeeeeee!  ;D

botman

--------------------------------------------------
05/05/03 at 12:56:34  Reply by: drick (crypton@ix.netcom.com)
--------------------------------------------------
where is this file located to edit??

QUOTE:
Here's the fix.  In h_export.cpp change this (in the GiveFnptrsToDll function)...
   // find the directory name of the currently running MOD...
   (*g_engfuncs.pfnGetGameDir)(game_dir);

   pos = strlen(game_dir) - 1;

   // scan backwards till first directory separator...
   while ((pos) && (game_dir != '/'))
      pos--;

   if (pos == 0)
   {
      // Error getting directory name!

            ALERT( at_error, "HPB_bot - Error determining MOD directory name!" );
   }

   pos++;
   strcpy(mod_name, &game_dir);
...to this...
   // find the directory name of the currently running MOD...
   (*g_engfuncs.pfnGetGameDir)(game_dir);

   pos = 0;

   if (strstr(game_dir, "/") != NULL)
   {
      pos = strlen(game_dir) - 1;

      // scan backwards till first directory separator...
      while ((pos) && (game_dir != '/'))
         pos--;

      if (pos == 0)
      {
         // Error getting directory name!

               ALERT( at_error, "HPB_bot - Error determining MOD directory name!" );
      }

      pos++;
   }

   strcpy(mod_name, &game_dir);
Valve changed the way the pfnGetGameDir() function worked (by returning a partial path instead of the fully qualified pathname).

It will take me a little while to rebuild the Win32 and Linux binary version and make those plus the source code download available, but if you are modifying the source code yourself, or want to build it yourself, that change shown above should fix the problem.

I should have the binary downloads available in the next hour or so, if you don't want to build things yourself.

botman



--------------------------------------------------
05/05/03 at 13:49:17  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
It's in the 'dlls' folder of the HPB bot source code.  Just edit the file, then use Microsoft Visual Studio to open the .dsp project workspace and build the DLL (or use the Makefile_Linux makefile to build the Linux shared library).

botman

--------------------------------------------------
05/05/03 at 15:01:38  Reply by: BAStumm (bs@bs-linux.com)
--------------------------------------------------
or download HPB_bot version 3 which has these changes pre-compiled in.

I see others are still having issues getting your bots to work under x111 botman. Just to state again, things are working fine for me after applying the changes you mentioned above. I dont use metamod so I can't comment on that side, but for a non-metamod user the bots are running fine. 18 or so hours now and no crash yet. 

--------------------------------------------------
05/05/03 at 16:03:55  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
Metamod may or may not have a similar problem determining which MOD is running (it was originally based off of some of my early HPB bot code and that low level stuff hasn't changed much at all in the last 2 or 3 years).

Metmod may be releasing a new version in the next few days if there really is a metamod issue with the x.1.1.1 dedicated server release.

The metamod guys are usually pretty quick to fix any crash related issues.

botman

--------------------------------------------------
05/05/03 at 16:19:16  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
I just looked at an old version of the metamod source code (I had version 1.12.4) and it had this code in meta_load_gamedll()...
code:
      GET_GAME_DIR(GameDLL.gamedir);
      cp=strrchr(GameDLL.gamedir, '/') + 1;
      STRNCPY(GameDLL.name, cp, sizeof(GameDLL.name));

metamod is also expecting to find a '/' in the filename (which would be there if the engine returned a fully qualified pathname, but now only returns the MOD directory name, like 'valve', 'tfc', or 'cstrike').

The strrchr() function returns the position within a string of the last occurence of a character (they are looking for the last '/' in the pathname)...

http://www.mkssoftware.com/docs/man3/strrchr.3.asp

strrchr() returns NULL if the character is not found (which in this case, the character WILL NOT be found).

STRNCPY() will then be called with a NULL parameter and the string will not get copied.

It looks like my older version of metamod will definitely break with the x.1.1.1 version of the dedicated server.  I'll download the latest version of metamod and see if that code is the same.

botman


--------------------------------------------------
05/05/03 at 16:22:52  Reply by: botman (botman@planethalflife.com)
--------------------------------------------------
Ha!  Here's the same code from metamod 1.15.3 (the latest version)...
code:
      GET_GAME_DIR(gamedir);
      normalize_pathname(gamedir);
      //
      // As of 1.1.1.1, the engine routine GET_GAME_DIR no longer returns a
      // full-pathname, but rather just the path specified as the argument to
      // "-game".
      //
      // However, since we have to work properly under both the new version
      // as well as previous versions, we have to support both possibilities.
      //
      // Note: the code has always assumed the server op wouldn't do:
      //    hlds -game other/firearms
      //

They've already fixed this problem in the release from 2 days ago.

If you haven't downloaded the latest and greatest metamod build, you WILL need to do this if you are running the 4.1.1.1 or 3.1.1.1 version of the dedicated server.

botman

